<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>My Appointments - Immacare</title>
  <link rel="stylesheet" href="/bootstrap/css/bootstrap.min.css" />
  <link rel="stylesheet" href="/bootstrap-icons/font/bootstrap-icons.min.css" />
  <script src="/bootstrap/js/bootstrap.bundle.min.js"></script>
  <script src="/jquery/jquery.min.js"></script>
  <link rel="stylesheet" href="/datatables.net-dt/css/dataTables.dataTables.css" />
  <script src="/datatables.net/js/dataTables.js"></script>
  <script src="/datatables.net/js/dataTables.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <link rel="stylesheet" href="patient.css" />
  <style>
    .badge-booked {
      background-color: #0d6efd;
      color: white;
    }

    .badge-completed {
      background-color: #198754;
      color: white;
    }

    .badge-emergency {
      background-color: #dc3545;
      color: white;
    }

    .badge-cancelled {
      background-color: #dc3545;
      color: white;
    }

    .badge-inqueue {
      background-color: #ffc107;
      color: #212529;
    }

    .nav-tabs .nav-link {
      color: #495057;
    }

    .nav-tabs .nav-link.active {
      color: #0d6efd;
      font-weight: 500;
    }

    .table th {
      font-weight: 500;
    }

    .labelTag {
      font-size: 1.1rem;
    }
  </style>
</head>

<body>
  <div class="card shadow-lg rounded p-4">
    <div class="d-flex justify-content-between align-items-center mb-3">
      <h2 class="mb-0">My Appointments</h2>
      <input type="hidden" id="user_id" />
      <input type="hidden" id="role" />
    </div>



    <!-- Appointment History Section -->
    <div id="appointment-history" class="mt-3">
      <div class="d-flex justify-content-between align-items-center mb-2 flex-wrap gap-2">
        <div class="d-flex align-items-center gap-2 flex-wrap">
          <label class="mb-0 small">Filter:</label>
          <input type="date" class="form-control form-control-sm" id="appointmentDateFrom" style="width: 140px;">
          <span class="small">to</span>
          <input type="date" class="form-control form-control-sm" id="appointmentDateTo" style="width: 140px;">
          <button type="button" class="btn btn-sm btn-secondary" onclick="filterAppointmentHistory()">
            <i class="bi bi-funnel"></i> Apply
          </button>
          <button type="button" class="btn btn-sm btn-outline-secondary" onclick="clearAppointmentFilter()">
            Clear
          </button>
        </div>
        <button type="button" class="btn btn-outline-primary btn-sm" onclick="printAppointmentHistory()">
          <i class="bi bi-printer me-1"></i>Print
        </button>
      </div>
      <div class="table-responsive">
        <table id="appointmentTable" class="table table-striped table-bordered table-hover">
          <thead>
            <tr>
              <th>Date</th>
              <th>Time</th>
              <th>Consultation Type</th>
              <th>Doctor</th>
              <th>Status</th>
            </tr>
          </thead>
          <tbody id="appointmentBody">
          </tbody>
        </table>
      </div>
      <div id="noAppointments" class="text-center text-muted py-4" style="display: none;">
        <i class="bi bi-calendar-x fs-1"></i>
        <p>No appointment history found.</p>
      </div>
    </div>
  </div>

  <script>
    let appointmentTable = null;
    let allAppointments = [];

    $(document).ready(function () {
      // Get user info from session API
      getSession();
    });

    // Get session data from server
    function getSession() {
      fetch("/homepage", {
        method: "GET",
        credentials: "include",
      })
        .then((response) => {
          if (!response.ok) {
            return response.json().then((err) => {
              throw new Error(err.message);
            });
          }
          return response.json();
        })
        .then((data) => {
          console.log('[PATIENT_APPOINTMENTS] Session data:', data);
          $('#user_id').val(data.user_id);
          $('#role').val(data.role);

          // Now load patient history
          loadAppointmentHistory();
        })
        .catch((error) => {
          console.error('[PATIENT_APPOINTMENTS] Error getting session:', error);
        });
    }

    function getStatusBadge(status) {
      const badges = {
        'Booked': '<span class="badge badge-booked">Booked</span>',
        'Completed': '<span class="badge badge-completed">Completed</span>',
        'Emergency': '<span class="badge badge-emergency">Emergency</span>',
        'Cancelled': '<span class="badge badge-cancelled">Cancelled</span>',
        'In Queue': '<span class="badge badge-inqueue">In Queue</span>'
      };
      return badges[status] || `<span class="badge bg-secondary">${status}</span>`;
    }

    function loadAppointmentHistory() {
      const userId = $('#user_id').val();
      if (!userId) return;

      $.ajax({
        url: `/getPatientAppointmentHistory/${userId}`,
        method: 'GET',
        success: function (response) {
          allAppointments = response.data || [];
          renderAppointmentTable(allAppointments);
        },
        error: function () {
          $('#appointmentTable').hide();
          $('#noAppointments').show();
        }
      });
    }

    function renderAppointmentTable(data) {
      const tbody = $('#appointmentBody');
      tbody.empty();

      if (data && data.length > 0) {
        $('#appointmentTable').show();
        $('#noAppointments').hide();

        data.forEach(function (apt) {
          tbody.append(`
              <tr>
                <td>${apt.booking_date || 'N/A'}</td>
                <td>${apt.booking_time || 'N/A'}</td>
                <td>${apt.consultation_type || 'N/A'}</td>
                <td>${apt.doctor_name || 'Not Assigned'}</td>
                <td>${getStatusBadge(apt.status)}</td>
              </tr>
            `);
        });

        if (appointmentTable) appointmentTable.destroy();
        appointmentTable = $('#appointmentTable').DataTable({
          order: [[0, 'desc']],
          pageLength: 10
        });
      } else {
        $('#appointmentTable').hide();
        $('#noAppointments').show();
      }
    }

    function filterAppointmentHistory() {
      const from = $('#appointmentDateFrom').val();
      const to = $('#appointmentDateTo').val();
      const filtered = allAppointments.filter(a => {
        if (!a.booking_date) return false;
        const date = a.booking_date;
        if (from && date < from) return false;
        if (to && date > to) return false;
        return true;
      });
      if (appointmentTable) appointmentTable.destroy();
      appointmentTable = null;
      renderAppointmentTable(filtered);
    }

    function clearAppointmentFilter() {
      $('#appointmentDateFrom').val('');
      $('#appointmentDateTo').val('');
      if (appointmentTable) appointmentTable.destroy();
      appointmentTable = null;
      renderAppointmentTable(allAppointments);
    }

    function printAppointmentHistory() {
      window.print();
    }
  </script>
</body>

</html>